<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <object th:include="~{fragments/common :: js}" th:remove="tag"></object>
  <object th:include="~{fragments/common :: css}" th:remove="tag"></object>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Home | InvoiceSync</title>
</head>
<body>
    <nav th:replace="~{fragments/navbar-finance :: navbar-finance-exc(page='Home')}"></nav>
    <!-- <div class="container">
        <div class="row">
            <div class="col">
              <h1 th:if="${showModal}" class="center-text theme-color">Halo, <span th:text="${email}"></span></h1>
              <h1 th:unless="${showModal}" class="center-text theme-color">Halo, <span th:text="${employee.first_name} + ' ' + ${employee.last_name}"></span></h1>
            </div>
        </div>
      </div> -->
    <!-- Modal -->
    <div id="myModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title theme-color">Complete Your Profile Now</h4>
                </div>
                <div class="modal-body">
                    <p class="theme-color" >First time on the system? Please <a th:href="@{/profile-page/edit}">complete your profile</a> first before using InvoiceSync.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row dashboard-row">
            <div class="col dashboard-col p-3" style="background-color: rgb(63, 38, 133);">
                <div class="card-title text-left">
                    <h3 th:if="${showModal}" class="center-text theme-color">Halo, <span th:text="${email}"></span></h3>
                    <h4 th:unless="${showModal}" class="text-left text-white">Welcome to InvoiceSync, <span th:text="${employee.first_name} + ' ' + ${employee.last_name}"></span></h4>
                    <p class="text-left text-white">InvoiceSync is a web-based invoice management system made for a consulting firm that facilitates invoice creation, invoice approval, dashboards, and user management.</p>
                </div>
            </div>
        </div>
        <div class="row dashboard-row">
            <div class="col dashboard-col">
                <div class="dashboard-content">
                    <h4>Total Paid Amount</h4>
                    <h5 id="formattedPaidAmount" th:text="${invoicePaidAmount}" class="theme-color"></h5>
                </div>
            </div>
            <div class="col dashboard-col-middle">
                <div class="dashboard-content">
                    <h4>Total Unpaid Amount</h4>
                    <h5 id="formattedUnpaidAmount" th:text="${invoiceUnpaidAmount}" class="theme-color"></h5>
                </div>
            </div>
            <div class="col dashboard-col">
                <div class="dashboard-content">
                    <h4>Total Overdue Amount</h4>
                    <h5 id="formattedOverdueAmount" th:text="${invoiceOverdueAmount}" class="theme-color"></h5>
                </div>
            </div>
        </div>
        <div class="row dashboard-row">
            <div class="col dashboard-col">
                <div class="dashboard-content">
                    <h4 class="text-center">Monthly Revenue</h4>
                    <div id="line_chart"></div>
                </div>
            </div>
        </div>
        <div class="row dashboard-row">
            <div class="col-md-4 dashboard-col">
                <div class="dashboard-content">
                    <h4 class="text-center">Top 5 Customers by Invoice</h4>
                    <div id="customerPieChart" style="height: 250px;"></div>
                </div>
            </div>
            <div class="col-md-4 dashboard-col">
                <div class="dashboard-content">
                    <h4 class="text-center">Top 5 Products by Invoice</h4>
                    <div id="productPieChart" style="height: 250px;"></div>
                </div>
            </div>
            <div class="col-md-4 dashboard-col">
                <div class="dashboard-content">
                    <h4 class="text-center">Invoice Payment Status Ratio</h4>
                    <div id="invoiceStatusPieChart" style="height: 250px;"></div>
                </div>
            </div>
        </div>
        
        </div>
    </div>

  <!-- JavaScript code to handle modal display -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script>

    var showModal = "[[${showModal}]]";

    if (showModal == "true") {
        document.getElementById('myModal').style.display = 'block';
    }
  </script>

<script type="text/javascript">
    google.charts.load('current', {
        'packages':['corechart', 'line']
    });
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts() {
        drawRevenueChart();
        drawCustomerChart();
        drawProductChart();
        drawStatusChart();
    }

    function drawRevenueChart() {
        fetch('/api/dashboard/revenue')
            .then(response => response.json())
            .then(data => {
                const dataTable = new google.visualization.DataTable();
                dataTable.addColumn('string', 'Month');
                dataTable.addColumn('number', 'Revenue');
                
                if (data.length === 0) {
                    dataTable.addRow(['No Data', 0]);
                } else {
                    data.forEach(item => {
                        dataTable.addRow([item.month, parseFloat(item.revenue)]);
                    });
                }

                var options = {
                    hAxis: {title: 'Month'},
                    vAxis: {title: 'Revenue', minValue: 0},
                    legend: 'none',
                    pointSize: 5,
                    curveType: 'function',
                    height: 500,
                    chartArea: {width: '60%', height: '75%'}
                };

                var chart = new google.visualization.LineChart(document.getElementById('line_chart'));
                chart.draw(dataTable, options);
            })
            .catch(error => console.error('Error loading the revenue data:', error));
    }

    function drawCustomerChart() {
        fetch('/api/dashboard/top-customers')
            .then(response => response.json())
            .then(topCustomers => {
                if (topCustomers.length === 0) {
                    document.getElementById('customerPieChart').innerHTML = '<div class="text-center">No data found in the system</div>';
                } else {
                    var data = new google.visualization.DataTable();
                    data.addColumn('string', 'Customer');
                    data.addColumn('number', 'Total Invoiced');
                    
                    topCustomers.forEach(customer => {
                        data.addRow([customer.customerName, customer.invoiceCount]);
                    });

                    var options = {
                        pieHole: 0.4,
                        height: 250
                    };

                    var chart = new google.visualization.PieChart(document.getElementById('customerPieChart'));
                    chart.draw(data, options);
                }
            })
            .catch(error => console.error('Error fetching top customers data:', error));
    }

    function drawProductChart() {
        fetch('/api/dashboard/top-products')
            .then(response => response.json())
            .then(topProducts => {
                if (topProducts.length === 0) {
                    document.getElementById('productPieChart').innerHTML = '<div class="text-center">No data found in the system</div>';
                } else {
                    var data = new google.visualization.DataTable();
                    data.addColumn('string', 'Products');
                    data.addColumn('number', 'Total Invoiced');

                    topProducts.forEach(product => {
                        data.addRow([product.productName, product.invoiceCount]);
                    });

                    var options = {
                        pieHole: 0.4,
                        height: 250
                    };

                    var chart = new google.visualization.PieChart(document.getElementById('productPieChart'));
                    chart.draw(data, options);
                }
            })
            .catch(error => console.error('Error fetching top customers data:', error));
    }

    function drawStatusChart() {
        fetch('/api/dashboard/invoice-ratio')
            .then(response => response.json())
            .then(invoiceStatus => {
                if (invoiceStatus.length === 0) {
                    document.getElementById('invoiceStatusPieChart').innerHTML = '<div class="text-center">No data found in the system</div>';
                } else {
                    var data = new google.visualization.DataTable();
                    data.addColumn('string', 'Status');
                    data.addColumn('number', 'Total Invoice Count');

                    invoiceStatus.forEach(invoice => {
                        data.addRow([invoice.status, invoice.count]);
                    });

                    var options = {
                        pieHole: 0.4,
                        height: 250
                    };

                    var chart = new google.visualization.PieChart(document.getElementById('invoiceStatusPieChart'));
                    chart.draw(data, options);
                }
            })
            .catch(error => console.error('Error fetching top customers data:', error));
    }

    document.addEventListener('DOMContentLoaded', function() {
    formatAmount('formattedPaidAmount');
    formatAmount('formattedUnpaidAmount');
    formatAmount('formattedOverdueAmount');
    
    });

    function formatAmount(elementId) {
        const element = document.getElementById(elementId);
        const amount = parseFloat(element.textContent);
        if (isNaN(amount)) {
            element.textContent = 'None';
            return;
        }

        const formatter = new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 2
        });

        element.textContent = formatter.format(amount);
    }
</script>

</body>
</html>
