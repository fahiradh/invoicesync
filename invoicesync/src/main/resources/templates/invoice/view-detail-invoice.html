<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <object th:include="~{fragments/common :: js}" th:remove="tag"></object>
  <object th:include="~{fragments/common :: css}" th:remove="tag"></object>
  <title>InvoiceSync</title>
  <style>
    .table-custom th, .table-custom td {
    border: none;
    text-align: center;        /* Teks rata tengah horizontal */
    vertical-align: middle;    /* Teks rata tengah vertikal */
}
</style>
</head>

<body>
    <nav th:replace="~{fragments/navbar-non-finance :: navbar-non-finance-staff(page = 'Create-Invoice')}"></nav>
    <!-- <div> -->
    <div class="header">
        <h4>Detail Invoice / <span class="invoice-number" th:text="${invoice.invoiceNumber}"></span></h4>
    </div>
    <!-- Tombol Print dan Edit -->
    <form th:action="@{/invoice/{invoiceNumber}(invoiceNumber=${invoice.invoiceNumber.replace('/', '_')})}" th:object="${invoice}" method="GET" id="invoiceForm">
        <a id="printButton" class="btn btn-primary" href="/">Print</a> 
        <a class="btn btn-primary" th:href="@{/invoice/{invoiceNumber}/edit(invoiceNumber=${invoice.invoiceNumber.replace('/','_')})}">Edit</a>
        <th:block th:if="${invoice.status == 'Waiting for Approver'}">
            <a class="btn btn-primary" href="#">Assign Approver</a>
        </th:block>
    </form>
    <!-- </div> -->
    <div class="grid-container-invoice-logs">
        <!-- Bagian invoice -->
        <div class="grid-container-invoice-logs-child">
            <div class="card ml-5 mr-5 mt-3 mb-5">
                <div class="card-body p-4">
                <div class="container-title">
                    <div class="row">
                        <div class="col" style="text-align:left;">
                            <h3 th:text="${invoice.invoiceNumber}"></h3>
                        </div>
                        <div class="col" style="text-align:right;" th:include="fragments/invoice-status :: invoice-status-show"></div>
                    </div>
                </div>
                <hr>
                <div class="content">
                    <div class="justify-content-center">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><p class="card-text mb-0">Customer</p></td>
                                        <td><input class="form-control" type="text" th:value="${invoice.customer.name}" readonly /></td>     
                                    </tr>
                                    <tr>
                                        <td><p class="card-text mb-0">Contact</p></td>
                                        <td><input class="form-control" type="text" th:value="${invoice.customer.contact}" readonly /></td>
                                    </tr>
                                    <tr>
                                        <td><p class="card-text mb-0">Address</p></td>
                                        <td><input class="form-control" type="text" th:value="${invoice.customer.address}" readonly /></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><p class="card-text mb-0">Invoice Date</p></td>
                                        <td><input class="form-control" th:value="${date}" readonly /></td>
                                    </tr>
                                    <tr>
                                        <td><p class="card-text mb-0">Due Date</p></td>
                                        <td><input class="form-control" type="date" th:value="${invoice.dueDate}" readonly/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <hr>
                        <p class="card-info">Please attach document or input the fields below to add product list.</p>
                        <br>
    
                        <p class="card-text">Attach Product List (.xlsx)</p>
                        <input type="file" class="form-control" id="file" name="file" accept=".xlsx" style="width: 35%;">
                        <input th:field="${invoice.productDocument}" hidden/>
                        <br>
    
                        <table class="table table-bordered">
                            <thead class="bg-dark text-white">
                                <tr>
                                    <th>No</th>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Price/Qty</th>
                                    <th>Total Price</th>
                                </tr>
                            </thead> 
                            <tbody>
                                <tr th:each="product, iterationStatus: ${listProduct}">
                                    <td th:text="${iterationStatus.count}">#</td>
                                    <td th:text="${product.description}"></td>
                                    <td th:text="${product.quantity}"></td>
                                    <td th:text="${product.price}"></td>
                                    <td th:text="${product.totalPrice}"></td>
                                </tr>
                            </tbody>
                        </table>
    
                        <hr>
    
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <p class="card-text">Payment Information</p>
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><p class="card-text mb-0">Bank Name</p></td>
                                            <td><input class="form-control" type="text" th:field="${invoice.bankName}" readonly /></td>
                                        </tr>
                                        <tr>
                                            <td><p class="card-text mb-0">Account Number</p></td>
                                            <td><input class="form-control" type="text" th:field="${invoice.accountNumber}" readonly/></td>
                                        </tr>
                                        <tr>
                                            <td><p class="card-text mb-0">Account Name</p></td>
                                            <td><input class="form-control" type="text" th:field="${invoice.accountName}" readonly/></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-4">
                                <table class="table table-bordered-classic">
                                    <tr>
                                        <td><p class="card-text mb-0">Subtotal</p></td>
                                        <td>
                                            <input class="form-control" type="number" th:field="${invoice.subtotal}" readonly />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><p class="card-text mb-0">Total Discount (%)</p></td>
                                        <td><input class="form-control" type="number" th:field="${invoice.totalDiscount}" readonly/></td>
                                    </tr>
                                    <tr>
                                        <td><p class="card-text mb-0">Tax</p></td>
                                        <td>
                                            <div id="taxList" th:each="tax : ${taxList}">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                        value="${tax.taxId}" 
                                                        id="${tax.taxId}" 
                                                        th:checked="${#lists.contains(taxList.![taxId], tax.taxId)}" disabled>
                                                    <label class="form-check-label" for="${tax.taxId}" th:text="${tax.taxName}">
                                                    </label>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><p class="card-text mb-0">Taxes</p></td>
                                        <td>
                                            <input class="form-control" th:field="${invoice.taxTotal}" type="number" disabled />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><p class="card-text mb-0">Grand Total</p></td>
                                        <td>
                                            <input class="form-control" th:field="${invoice.grandTotal}" type="number"  disabled />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><p class="card-text mb-0">Amount in Words</p></td>
                                        <td><input class="form-control" type="text" th:field="${invoice.totalWords}" readonly/></td>
                                    </tr> 
                                </table>
                            </div>
                        </div>
                    </div>
                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <p class="card-info">Please attach additional documents for approval.</p>
                                <br>
                                <p class="card-text">Additional Document</p>
                                <input type="file" class="form-control" name="file"/>
                                <input type="hidden" th:field="${invoice.additionalDocument}" readonly/>
                            </div>
                        </div>
    
                        <div class="col-md-6">
                            <div class="mb-4">
                                <p class="card-text">Signature</p>
                                <div class="form-inline">
                                    <div class="form-group mr-2">
                                        <input class="form-control" type="text" th:field="${invoice.city}" readonly />
                                    </div>
                                    <div class="form-group">
                                        <p class="card-text" th:text="', '+${invoice.invoiceDate}"></p>
                                    </div>
                                </div>
                                <br>
                                <input type="file" class="form-control" name="image"/>
                                <input type="hidden" th:field="${image}" />
                                <br>
                            </div>
                        </div>
                    </div>
                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <p class="card-info">Please attach additional documents for approval.</p>
                                <br>
                                <p class="card-text">Additional Document</p>
                                <input type="file" class="form-control" name="file"/>
                                <input type="hidden" th:value="${invoice.additionalDocument}" />
                            </div>
                        </div>

                            <div class="col-md-6">
                                <div class="mb-4">
                                    <p class="card-text">Signature</p>
                                    <div class="form-inline">
                                        <div class="form-group mr-2">
                                            <input class="form-control" type="text" th:value="${invoice.city}"  readonly/>
                                        </div>
                                        <div class="form-group">
                                            <p class="card-text" th:text="', '+${dateInvoice}"></p>
                                        </div>
                                    </div>
                                    <br>
                                    <div class="drag-area">
                                        <img class="card-img-top" th:src="@{'data:image/jpeg;base64,' + ${image}}" alt="signature-image" style="max-height:150px;">
                                    </div>
                                    <br>
                                    <input class="form-control" type="text" th:value="${invoice.staffEmail}" readonly />
                                    <br>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bagian approval log -->
        <div class="grid-container-invoice-logs-child">
            <div class="container-logs">
                <div class="container title" style="text-align: center; margin-bottom: 0;">
                    <h3>Approval Log</h3>
                </div>
                <hr>
                <div class="grid-container-logs">
                    <div class="grid-container log">
                        <div class="left">
                            <img src="" alt="" class="rounded-photo log default-photo">
                        </div>
                        <div class="name">
                            <p><b>David Beckham</b></p>
                        </div>
                        <div class="date">
                            <p style="font-size: smaller;"><i>3 April 2023</i></p>
                        </div>
                        <div class="position">
                            <p>Manager Nonfinance</p>
                        </div>
                        <div class="status">
                            <div class="oval-status" style="background-color: #3B9C8F;">
                                <p style="
                                    font-size: smaller;
                                    color: whitesmoke;
                                    "><b>Approved</b></p>
                            </div>
                        </div>
                    </div>
                    <div class="grid-container log">
                        <div class="left">
                            <img src="" alt="" class="rounded-photo log default-photo">
                        </div>
                        <div class="name">
                            <p><b>David Beckham</b></p>
                        </div>
                        <div class="date">
                            <p style="font-size: smaller;"><i>3 April 2023</i></p>
                        </div>
                        <div class="position">
                            <p>Manager Nonfinance</p>
                        </div>
                        <div class="status">
                            <div class="oval-status" style="background-color: #FFDB20;">
                                <p style="
                                    font-size: smaller;
                                    color: white;
                                    "><b>Need Revision</b></p>
                            </div>
                        </div>
                        <div class="additional">
                            <div class="additional-content" style="
                                    background-color: #ECF1F4; 
                                    border-radius: 25px;
                                    border-top-left-radius: 0;
                                    padding: 10px;
                                    padding-top: 5px;">
                                <span style="margin-bottom: 10px;"><b>Comment</b></span>
                                <p>Tolong diisi yah additional documentnya thankk you yah 
                                    Tolong diisi yah additional documentnya thankk you yah 
                                    Tolong diisi yah additional documentnya thankk you yah 
                                    Tolong diisi yah additional documentnya thankk you yah 
                                </p>
                                <a href="https://documentcloud.adobe.com/spodintegration/index.html?locale=en-us" target="_blank">Read more</a>
                                <!-- <embed src="C:\Users\Neysa\Downloads\867-1955-1-PB.pdf" width="800px" height="2100px" /> -->
                            </div>
                        </div>
                    </div>
                    <div class="grid-container log">
                        <div class="left">
                            <img src="" alt="" class="rounded-photo log default-photo">
                        </div>
                        <div class="name">
                            <p><b>David Beckham</b></p>
                        </div>
                        <div class="date">
                            <p style="font-size: smaller;"><i>3 April 2023</i></p>
                        </div>
                        <div class="position">
                            <p>Manager Nonfinance</p>
                        </div>
                        <div class="status">
                            <div class="oval-status" style="background-color: #E93D3D;">
                                <p style="
                                    font-size: smaller;
                                    color: whitesmoke;
                                    "><b>Rejected</b></p>
                            </div>
                        </div>
                    </div>
                    <div class="additional-log">
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- Add Approver Modal -->
    <div class="modal fade" id="addApproverModal" tabindex="-1" role="dialog" aria-labelledby="addApproverModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addApproverModalLabel">Add Approver</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- The action URL should point to the controller method that handles adding an approver -->
                    <form th:action="@{/invoice/{invoiceNumber}/add-approver(invoiceNumber=${invoice.invoiceNumber.replace('/', '_')})}" method="post">
                        <!-- form inputs -->
                        <div class="form-group">
                            <label for="approverName">Approver Name</label>
                            <select class="form-control" id="approverName" name="approverEmail">
                                <option value="">Select Approver</option>
                                <!-- Iterate over employees and display first and last names -->
                                <option th:each="employee : ${employees}" 
                                        th:value="${employee.email}" 
                                        th:text="${employee.first_name + ' ' + employee.last_name}">
                                </option>
                            </select>                        
                        </div>
                        <div class="form-group">
                            <!-- Include hidden field to hold the invoice number or ID -->
                            <input type="hidden" name="invoiceNumber" th:value="${invoice.invoiceNumber}" />
                        </div>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Existing HTML code -->

 <!-- Approver List Section -->
 <div class="container-invoice">
    <div class="card mt-3 mb-5" style="width: 100%;"> <!-- Set the width to 100% of the container -->
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addApproverModal">Add Approver</button>
        <div class="card-header">
            <h5 class="card-title">Approvers</h5>
        </div>
        <div class="card-body">
            <table class="table table-custom" id="approversTable">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Approver</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Iteration over approvers -->
                    <tr th:each="approver, iterStat : ${approvers}">
                        <td th:text="${iterStat.count}"></td>
                        <td th:text="${approver.employee.first_name + ' ' + approver.employee.last_name}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
  

<!-- Rest of your existing HTML including the Add Approver Modal -->
<script>
    /*<![CDATA[*/
$(document).ready(function() {
  $('#addApproverForm').submit(function(event) {
    event.preventDefault();
    var formData = $(this).serialize(); // Serialize form data for submission
    // Update the AJAX call as per your form serialization
    $.ajax({
      url: "@{/invoice/{invoiceNumber}/add-approver(invoiceNumber=${invoice.invoiceNumber.replace('/', '_')})}", // Update this URL to your POST endpoint
      type: 'POST',
      data: formData, // Send the serialized form data
      success: function(response) {
        // Assuming the response contains the updated list of approvers
        var approversTable = $('#approversTable tbody');
        approversTable.empty(); // Clear existing rows
        $.each(response.approvers, function(i, approver) {
          approversTable.append('<tr>' +
                                  '<td>' + (i+1) + '</td>' +
                                  '<td>' + approver.employee.firstName + ' ' + approver.employee.lastName + '</td>' +
                                '</tr>');
        });
        $('#addApproverModal').modal('hide');
      },
      error: function() {
        alert('Error adding approver.');
      }
    });
  });
});
/*]]>*/

</script>
    <script src="/js/scripts/print-script.js"></script>
    
</body>
</html>
